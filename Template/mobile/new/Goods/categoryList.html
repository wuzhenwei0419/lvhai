<!DOCTYPE html >
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title>分类</title>

  <link href="__STATIC__/css/v1/mui.css" rel="stylesheet" />
  <link href="__STATIC__/css/v1/list.css" rel="stylesheet" />

  <style>
    .mui-row.mui-fullscreen>[class*="mui-col-"] {
      height: 100%;
    }

    .mui-col-xs-3,
    .mui-control-content {
      overflow-y: auto;
      height: 100%;
    }

    .mui-segmented-control .mui-control-item {
      line-height: 50px;
      width: 100%;
    }

    .mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
      background-color: #fff;
    }
  </style>
</head>
<body>
<header class="mui-bar mui-bar-nav max-header">
  <h1 class="mui-title">梦时鲜</h1>
</header>

<!-- 列表 -->
<div class="mui-content mui-row mui-fullscreen max-list">
  <div class="mui-col-xs-3">
    <div id="segmentedControls" class="mui-segmented-control mui-segmented-control-inverted mui-segmented-control-vertical">
      <foreach name="goods_category_tree" key="kk" item="vo">
        <assign name="m" value="0"/>
        <foreach name="vo.tmenu" item="v2" key="k2">
          <a <if condition="$cat_id eq $v2['id']">class="mui-control-item  mui-active" <else/> class="mui-control-item" </if> data-name="{$v2['name']}" data-id="{$m++}" href="{:U('Mobile/Goods/categoryList',array('id'=>$v2[id]))}">{$v2['name']}</a>
        </foreach>
      </foreach>
    </div>
  </div>
  <div id="segmentedControlContents" class="mui-col-xs-9">

    <div id="content1" class="mui-control-content mui-active">

      <!--下拉刷新容器-->
      <div id="pullrefresh" class="mui-content mui-scroll-wrapper ">
        <div class="mui-scroll">
          <div class="msx-title"><span></span></div>
          <!--数据列表-->
          <ul class="mui-table-view">

          </ul>
        </div>
      </div>

    </div>


  </div>
</div>

<!-- 占位 -->
<div class="sky-box"></div>

<nav class="mui-bar mui-bar-tab">
  <a class="mui-tab-item" href="{:U('Index/index')}">
    <span class="mui-icon"><img src="__STATIC__/images/v1/shouye.jpg" /></span>
    <span class="mui-tab-label">首页</span>
  </a>
  <a class="mui-tab-item mui-active" href="{:U('Goods/categoryList')}">
    <span class="mui-icon"><img src="__STATIC__/images/v1/fenlei1.jpg" /></span>
    <span class="mui-tab-label">分类</span>
  </a>
  <a class="mui-tab-item" href="{:U('Cart/cart')}">
				<span class="mui-icon">
					<img src="__STATIC__/images/v1/gouwuche.jpg" />
					<span class="mui-badge mui-badge-warning">3</span></span>
    <span class="mui-tab-label">购物车</span>
  </a>
  <a class="mui-tab-item" href="{:U('User/index')}">
    <span class="mui-icon"><img src="__STATIC__/images/v1/wode.jpg" /></span>
    <span class="mui-tab-label">我的</span>
  </a>
</nav>

<script src="__STATIC__/js/v1/mui.min.js"></script>
<script type="text/javascript" charset="utf-8">
    var lastId = '',
        minId = ''; //最新新闻的id
    var page = 1;

    mui.init({
        swipeBack: false,
        pullRefresh: {
            container: '#pullrefresh',
            down: {
                style:'circle',
                auto: true,
                height:'50px',
                callback: pulldownRefresh
            },
            up: {
                contentrefresh: '正在加载...',
                callback: pullupRefresh
            }
        }
    });

    //处理点击事件，需要打开原生浏览器
    mui('body').on('tap', 'a', function(e) {
        var href = this.getAttribute('href');
        if (href) {
            if (window.plus) {
                plus.runtime.openURL(href);
            } else {
                location.href = href;
            }
        }

    });

    var data_name = document.querySelector('.mui-active').innerText;
    var msxTitle = document.querySelector('.msx-title span');
    if(data_name){
        msxTitle.innerHTML='<i></i>'+data_name+'<i></i>';
    }


    /**
     * 下拉刷新具体业务实现
     */
    function pulldownRefresh() {
        if(window.plus && plus.networkinfo.getCurrentType() === plus.networkinfo.CONNECTION_NONE) {
            plus.nativeUI.toast('似乎已断开与互联网的连接', {
                verticalAlign: 'top'
            });
            return;
        }

        //请求最新列表信息流
        mui.getJSON("/index.php?m=Mobile&c=Goods&a=ajaxGoodsPage", {
            "id": {$cat_id},
            "p": page
        }, function(rsp) {

            console.log(rsp);
            if(rsp.status == 1){
                var result = rsp.result;
                if(result && result.length > 0) {
                    page++;
                    var table = document.body.querySelector('.mui-table-view');
                    for (var i in result) {
                        var li = document.createElement('li');
                        li.className = 'mui-table-view-cell mui-media';

                        li.innerHTML = '<a href="/Mobile/Goods/goodsInfo/id/'+result[i].goods_id+'.html"><div class="mui-media-object mui-pull-left"><img  src="'+result[i].original_img+'"></div><div class="mui-media-body"><p class="mui-ellipsis-2">'+result[i].goods_name+'</p><p class="mui-ellipsis">登陆查看价格</p><p class="msx-add">￥<span>:-)</span>/箱 <img src="__STATIC__/images/v1/list_03.jpg" ></p></div></a>';

                        //下拉刷新，新纪录插到最前面；
                        table.insertBefore(li, table.firstChild);
                    }
                    mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
                }else {
                    mui('#pullrefresh').pullRefresh().endPulldownToRefresh(true);
                }
            }

        });

    }
    /**
     * 上拉加载具体业务实现
     */
    function pullupRefresh() {
        //请求最新列表信息流
        mui.getJSON("/index.php?m=Mobile&c=Goods&a=ajaxGoodsPage", {
            "id": {$cat_id},
            "p": page
        }, function(rsp) {
            console.log(rsp);
            if(rsp.status == 1){
                var result = rsp.result;
                if(result && result.length > 0) {
                    page++;
                    var table = document.body.querySelector('.mui-table-view');
                    for (var i in result) {
                        var li = document.createElement('li');
                        li.className = 'mui-table-view-cell mui-media';

                        li.innerHTML = '<a href="/Mobile/Goods/goodsInfo/id/'+result[i].goods_id+'.html"><div class="mui-media-object mui-pull-left"><img  src="'+result[i].original_img+'"></div><div class="mui-media-body"><p class="mui-ellipsis-2">'+result[i].goods_name+'</p><p class="mui-ellipsis">登陆查看价格</p><p class="msx-add">￥<span>:-)</span>/箱 <img src="__STATIC__/images/v1/list_03.jpg" ></p></div></a>';

                        table.appendChild(li);
                    }
                    mui('#pullrefresh').pullRefresh().endPullupToRefresh();
                }else {
                    mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
                }
            }

        });

    }
</script>
</body>
</html>